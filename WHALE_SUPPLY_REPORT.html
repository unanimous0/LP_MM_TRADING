<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whale Supply — 외국인·기관 수급 분석 시스템 보고서</title>
<style>
  :root {
    --primary:   #1d4ed8;
    --accent:    #0ea5e9;
    --success:   #16a34a;
    --warning:   #d97706;
    --danger:    #dc2626;
    --neutral:   #64748b;
    --bg:        #ffffff;
    --bg2:       #f8fafc;
    --bg3:       #f1f5f9;
    --border:    #e2e8f0;
    --text:      #0f172a;
    --text2:     #475569;
    --text3:     #94a3b8;
    --radius:    8px;
    --shadow:    0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
    --shadow-md: 0 4px 6px rgba(0,0,0,.07), 0 2px 4px rgba(0,0,0,.06);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
    font-size: 15px; line-height: 1.75;
    color: var(--text); background: var(--bg);
    max-width: 1060px; margin: 0 auto; padding: 40px 32px 80px;
  }

  /* ── 커버 ── */
  .cover {
    background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 60%, #0ea5e9 100%);
    color: #fff; border-radius: 16px;
    padding: 56px 48px; margin-bottom: 56px;
    box-shadow: 0 8px 32px rgba(14,165,233,.25);
  }
  .cover .tag {
    display: inline-block; background: rgba(255,255,255,.15);
    border: 1px solid rgba(255,255,255,.3);
    border-radius: 999px; padding: 4px 14px;
    font-size: 12px; letter-spacing: .08em; margin-bottom: 20px;
  }
  .cover h1 { font-size: 36px; font-weight: 800; line-height: 1.2; margin-bottom: 12px; }
  .cover p  { font-size: 16px; color: rgba(255,255,255,.8); max-width: 640px; }
  .cover .meta {
    margin-top: 32px; display: flex; gap: 32px; flex-wrap: wrap;
    font-size: 13px; color: rgba(255,255,255,.65);
  }
  .cover .meta span b { color: #fff; }

  /* ── 목차 ── */
  .toc {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 28px 32px; margin-bottom: 56px;
  }
  .toc h2 { font-size: 15px; font-weight: 700; margin-bottom: 16px; color: var(--text2); letter-spacing:.05em; }
  .toc ol { padding-left: 20px; }
  .toc > ol > li { margin-bottom: 6px; font-weight: 600; }
  .toc > ol > li > ol { font-weight: 400; margin-top: 4px; }
  .toc a { color: var(--primary); text-decoration: none; }
  .toc a:hover { text-decoration: underline; }

  /* ── 섹션 ── */
  section { margin-bottom: 60px; }
  h2.sec {
    font-size: 22px; font-weight: 800;
    border-bottom: 3px solid var(--primary);
    padding-bottom: 10px; margin-bottom: 28px;
    display: flex; align-items: center; gap: 10px;
  }
  h2.sec .num {
    background: var(--primary); color: #fff;
    border-radius: 6px; padding: 2px 10px;
    font-size: 13px; font-weight: 700;
  }
  h3 { font-size: 17px; font-weight: 700; margin: 28px 0 12px; color: var(--text); }
  h4 { font-size: 15px; font-weight: 700; margin: 20px 0 8px; color: var(--text2); }
  p  { margin-bottom: 12px; color: var(--text); }

  /* ── 강조 박스 ── */
  .box {
    border-radius: var(--radius); padding: 20px 24px; margin: 20px 0;
    border-left: 4px solid;
  }
  .box.blue   { background: #eff6ff; border-color: var(--primary); }
  .box.sky    { background: #f0f9ff; border-color: var(--accent); }
  .box.green  { background: #f0fdf4; border-color: var(--success); }
  .box.amber  { background: #fffbeb; border-color: var(--warning); }
  .box.red    { background: #fef2f2; border-color: var(--danger); }
  .box.gray   { background: var(--bg2); border-color: var(--neutral); }
  .box p:last-child { margin-bottom: 0; }

  /* ── 수식 ── */
  .formula {
    background: #0f172a; color: #e2e8f0;
    border-radius: var(--radius); padding: 20px 28px; margin: 16px 0;
    font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.9;
    overflow-x: auto;
  }
  .formula .comment { color: #94a3b8; }
  .formula .key     { color: #38bdf8; font-weight: 700; }
  .formula .val     { color: #4ade80; }
  .formula .op      { color: #fb923c; }

  /* ── 테이블 ── */
  table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 14px; }
  th { background: var(--bg3); font-weight: 700; padding: 10px 14px; text-align: left; border: 1px solid var(--border); }
  td { padding: 9px 14px; border: 1px solid var(--border); vertical-align: top; }
  tr:nth-child(even) td { background: var(--bg2); }

  /* ── 배지 ── */
  .badge {
    display: inline-block; border-radius: 999px;
    padding: 2px 10px; font-size: 12px; font-weight: 700;
    margin: 2px;
  }
  .badge.blue   { background: #dbeafe; color: #1d4ed8; }
  .badge.green  { background: #dcfce7; color: #16a34a; }
  .badge.amber  { background: #fef3c7; color: #d97706; }
  .badge.red    { background: #fee2e2; color: #dc2626; }
  .badge.purple { background: #f3e8ff; color: #7c3aed; }
  .badge.gray   { background: #f1f5f9; color: #475569; }

  /* ── KPI 카드 ── */
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; margin: 20px 0; }
  .kpi-card {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    box-shadow: var(--shadow);
  }
  .kpi-card .label { font-size: 12px; color: var(--text3); font-weight: 600; margin-bottom: 4px; }
  .kpi-card .value { font-size: 24px; font-weight: 800; color: var(--primary); }
  .kpi-card .sub   { font-size: 12px; color: var(--text2); margin-top: 2px; }

  /* ── 스텝 ── */
  .steps { counter-reset: step; }
  .step {
    display: flex; gap: 20px; margin-bottom: 28px;
    padding-bottom: 28px; border-bottom: 1px solid var(--border);
  }
  .step:last-child { border-bottom: none; }
  .step-num {
    flex-shrink: 0; width: 36px; height: 36px;
    background: var(--primary); color: #fff;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 15px; margin-top: 2px;
  }
  .step-body h4 { margin-top: 0; }

  /* ── 비교 카드 ── */
  .compare { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
  .compare-card {
    border-radius: var(--radius); padding: 18px 20px;
    border: 1px solid var(--border);
  }
  .compare-card.before { background: #fff7f7; border-color: #fca5a5; }
  .compare-card.after  { background: #f0fdf4; border-color: #86efac; }
  .compare-card .cl { font-size: 11px; font-weight: 800; letter-spacing: .08em; margin-bottom: 8px; }
  .compare-card.before .cl { color: var(--danger); }
  .compare-card.after  .cl { color: var(--success); }

  /* ── 파이프라인 ── */
  .pipeline {
    display: flex; align-items: stretch; gap: 0; margin: 20px 0; flex-wrap: wrap;
  }
  .pipe-item {
    flex: 1; min-width: 150px;
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 0; padding: 16px 18px;
    position: relative;
  }
  .pipe-item:first-child { border-radius: var(--radius) 0 0 var(--radius); }
  .pipe-item:last-child  { border-radius: 0 var(--radius) var(--radius) 0; }
  .pipe-item + .pipe-item { border-left: none; }
  .pipe-item .stage { font-size: 11px; color: var(--text3); font-weight: 700; margin-bottom: 4px; }
  .pipe-item .title { font-size: 14px; font-weight: 700; color: var(--text); }
  .pipe-item .desc  { font-size: 12px; color: var(--text2); margin-top: 4px; }
  .pipe-item.active { background: var(--primary); border-color: var(--primary); }
  .pipe-item.active .stage,
  .pipe-item.active .title,
  .pipe-item.active .desc { color: #fff; }

  /* ── 시그널 카드 ── */
  .signal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap: 14px; margin: 16px 0; }
  .signal-card {
    border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px 18px; background: var(--bg2);
  }
  .signal-card h4 { margin: 0 0 8px; font-size: 14px; }
  .signal-card p  { font-size: 13px; color: var(--text2); margin: 0; }

  /* ── 패턴 카드 ── */
  .pattern-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 20px 0; }
  .pattern-card { border-radius: var(--radius); padding: 22px 20px; }
  .pattern-card.momentum { background: #eff6ff; border: 2px solid #3b82f6; }
  .pattern-card.sustained { background: #f0fdf4; border: 2px solid #22c55e; }
  .pattern-card.reversal  { background: #fdf4ff; border: 2px solid #a855f7; }
  .pattern-card h3 { margin: 0 0 10px; font-size: 15px; }
  .pattern-card p  { font-size: 13px; margin-bottom: 8px; }
  .pattern-card ul { padding-left: 18px; font-size: 13px; color: var(--text2); }

  /* ── 인용 ── */
  blockquote {
    border-left: 3px solid var(--accent);
    padding: 10px 20px; margin: 16px 0;
    background: var(--bg2); color: var(--text2);
    border-radius: 0 var(--radius) var(--radius) 0;
    font-style: italic;
  }

  /* ── 구분선 ── */
  hr { border: none; border-top: 1px solid var(--border); margin: 36px 0; }

  /* ── 부록 박스 ── */
  .appendix {
    background: #f8fafc; border: 1px solid var(--border);
    border-radius: var(--radius); padding: 24px 28px; margin-top: 20px;
  }

  /* ── 인터프리테이션 ── */
  .interp { display: grid; grid-template-columns: auto 1fr; gap: 0; margin: 12px 0; }
  .interp-val {
    padding: 8px 16px; font-weight: 800; font-size: 14px;
    border: 1px solid var(--border); background: var(--bg3);
    display: flex; align-items: center; border-radius: var(--radius) 0 0 var(--radius);
    white-space: nowrap; min-width: 120px;
  }
  .interp-desc {
    padding: 8px 16px; font-size: 13px; color: var(--text2);
    border: 1px solid var(--border); border-left: none;
    border-radius: 0 var(--radius) var(--radius) 0;
    background: var(--bg);
  }

  /* ── 반응형 ── */
  @media (max-width: 700px) {
    .pattern-grid { grid-template-columns: 1fr; }
    .compare { grid-template-columns: 1fr; }
    .pipeline { flex-direction: column; }
    .pipe-item { border-radius: var(--radius) !important; border-left: 1px solid var(--border) !important; }
    body { padding: 20px 16px 60px; }
    .cover { padding: 32px 24px; }
    .cover h1 { font-size: 26px; }
  }
  @media print {
    .cover { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    section { page-break-inside: avoid; }
  }
</style>
</head>
<body>

<!-- ══════════════════════════════════════════════════════════
     커버
══════════════════════════════════════════════════════════ -->
<div class="cover">
  <div class="tag">INTERNAL REPORT · 2026-02-25</div>
  <h1>🐋 Whale Supply<br>외국인·기관 수급 분석 시스템</h1>
  <p>
    KOSPI200 · KOSDAQ150 핵심 345 종목의 수급 데이터를 정규화하고,
    다기간 패턴 분류 및 백테스트를 통해 투자 의사결정을 지원하는 수급 기반 분석 플랫폼
  </p>
  <div class="meta">
    <span><b>분석 대상</b>  345 종목 (KOSPI200 + KOSDAQ150)</span>
    <span><b>데이터 기간</b>  2024-01-02 ~ 2026-01-20</span>
    <span><b>레코드 수</b>  171,227 건</span>
    <span><b>배포 방식</b>  Streamlit 웹 대시보드</span>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════
     목차
══════════════════════════════════════════════════════════ -->
<nav class="toc">
  <h2>목 차</h2>
  <ol>
    <li><a href="#s1">프로젝트 배경 및 목적</a></li>
    <li><a href="#s2">데이터 현황</a></li>
    <li><a href="#s3">핵심 지표 정의 및 수식</a>
      <ol>
        <li><a href="#s3-1">Sff (Supply Flow Force)</a></li>
        <li><a href="#s3-2">Combined Sff — 외국인 중심 조건부 합산</a></li>
        <li><a href="#s3-3">Z-Score — 조건부 공식</a></li>
        <li><a href="#s3-4">방향 확신도 (Direction Confidence)</a></li>
      </ol>
    </li>
    <li><a href="#s4">분석 파이프라인 전체 구조</a></li>
    <li><a href="#s5">패턴 분류 시스템</a>
      <ol>
        <li><a href="#s5-1">3가지 패턴 유형</a></li>
        <li><a href="#s5-2">점수 체계 (0 ~ 115점)</a></li>
        <li><a href="#s5-3">시간 일관성 (Temporal Consistency)</a></li>
        <li><a href="#s5-4">단기 모멘텀 (Short Trend)</a></li>
      </ol>
    </li>
    <li><a href="#s6">추가 시그널</a></li>
    <li><a href="#s7">백테스트 시스템</a></li>
    <li><a href="#s8">웹 대시보드 기능 안내</a></li>
    <li><a href="#s9">사용 방법 (Step-by-Step)</a></li>
    <li><a href="#s10">결과 해석 가이드</a></li>
    <li><a href="#s11">성능 및 처리 속도</a></li>
  </ol>
</nav>


<!-- ══════════════════════════════════════════════════════════
     1. 배경 및 목적
══════════════════════════════════════════════════════════ -->
<section id="s1">
<h2 class="sec"><span class="num">1</span> 프로젝트 배경 및 목적</h2>

<h3>왜 이 시스템을 만들었는가</h3>
<p>
  한국 주식시장에서 외국인과 기관 투자자의 순매수·순매도 데이터는 한국거래소(KRX)를 통해
  매일 공개됩니다. 이 데이터는 <strong>"큰 손"들의 방향성</strong>을 가장 직접적으로 보여주는
  지표임에도 불구하고, 그대로 사용하면 다음과 같은 한계가 있습니다.
</p>

<div class="compare">
  <div class="compare-card before">
    <div class="cl">❌ 원시 데이터의 한계</div>
    <ul style="padding-left:18px; font-size:13px; color:#7f1d1d;">
      <li>삼성전자 +1,000억 vs 중소형주 +10억 — 절대금액 비교 불가</li>
      <li>"오늘 외국인이 많이 샀다"의 기준 없음 (평소 대비 얼마나?)</li>
      <li>외국인 매수 중 기관 역매매 시 신호 상쇄</li>
      <li>단기 급등인지, 장기 매집인지 구분 불가</li>
      <li>매도 중인 종목이 통계적 착시로 상위 랭크</li>
    </ul>
  </div>
  <div class="compare-card after">
    <div class="cl">✅ Whale Supply의 해결</div>
    <ul style="padding-left:18px; font-size:13px; color:#14532d;">
      <li>Sff로 유통시총 대비 정규화 → 종목 간 직접 비교</li>
      <li>Z-Score로 "역사적으로 얼마나 이례적인가" 수치화</li>
      <li>외국인 중심 조건부 합산 → 기관 역매매 신호 보존</li>
      <li>7개 기간(5D~500D) 다기간 분석 → 단기/장기 패턴 구분</li>
      <li>방향 확신도(tanh)로 매도 종목 오분류 방지</li>
    </ul>
  </div>
</div>

<h3>핵심 목표</h3>
<div class="steps">
  <div class="step">
    <div class="step-num">1</div>
    <div class="step-body">
      <h4>수급 정규화 — 비교 가능한 지표 생성</h4>
      <p>절대금액이 아닌 유통시총 대비 비율(Sff)로 변환하고, N일 역사와 비교한 Z-Score를 계산하여
      삼성전자부터 소형주까지 동일한 기준으로 비교합니다.</p>
    </div>
  </div>
  <div class="step">
    <div class="step-num">2</div>
    <div class="step-body">
      <h4>패턴 분류 — 투자 스타일별 종목 발굴</h4>
      <p>7개 기간 Z-Score를 조합하여 모멘텀형(단기 급등), 지속형(장기 매집), 전환형(반전 초기)
      3가지 패턴으로 자동 분류합니다.</p>
    </div>
  </div>
  <div class="step">
    <div class="step-num">3</div>
    <div class="step-body">
      <h4>백테스트 — 전략의 과거 수익률 검증</h4>
      <p>분류된 패턴을 기반으로 과거 특정 기간에 동일 전략을 실행했을 때의 수익률, 승률, MDD,
      샤프 비율 등을 계산하여 전략의 유효성을 검증합니다.</p>
    </div>
  </div>
  <div class="step">
    <div class="step-num">4</div>
    <div class="step-body">
      <h4>파라미터 최적화 — Optuna Bayesian Optimization</h4>
      <p>최소 점수, 손절 비율, 목표 수익률, 최대 보유 기간 등 7개 파라미터를 Bayesian 최적화로
      자동 탐색하여 최적 전략 조합을 제안합니다.</p>
    </div>
  </div>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     2. 데이터 현황
══════════════════════════════════════════════════════════ -->
<section id="s2">
<h2 class="sec"><span class="num">2</span> 데이터 현황</h2>

<div class="kpi-grid">
  <div class="kpi-card">
    <div class="label">전체 레코드</div>
    <div class="value">171,227</div>
    <div class="sub">건 (수급 데이터)</div>
  </div>
  <div class="kpi-card">
    <div class="label">핵심 분석 종목</div>
    <div class="value">345</div>
    <div class="sub">KOSPI200 + KOSDAQ150</div>
  </div>
  <div class="kpi-card">
    <div class="label">데이터 기간</div>
    <div class="value">2년+</div>
    <div class="sub">2024-01-02 ~ 2026-01-20</div>
  </div>
  <div class="kpi-card">
    <div class="label">종목 마스터</div>
    <div class="value">1,609</div>
    <div class="sub">섹터 커버리지 97.9%</div>
  </div>
  <div class="kpi-card">
    <div class="label">데이터 컬럼</div>
    <div class="value">13개</div>
    <div class="sub">수급 + 주가 + 유통주식</div>
  </div>
</div>

<h3>데이터 구성</h3>
<table>
  <tr><th>항목</th><th>내용</th><th>출처</th></tr>
  <tr><td>외국인 순매수금액</td><td>당일 외국인 전체 순매수 금액 (원)</td><td>KRX (한국거래소)</td></tr>
  <tr><td>기관 순매수금액</td><td>당일 기관 전체 순매수 금액 (원)</td><td>KRX</td></tr>
  <tr><td>종가</td><td>당일 주식 종가 (원)</td><td>크롤링</td></tr>
  <tr><td>유통주식 수</td><td>유통 가능한 실질 주식 수</td><td>크롤링</td></tr>
  <tr><td>섹터</td><td>GICS 기준 섹터 분류</td><td>종목 마스터</td></tr>
</table>

<div class="box amber">
  <p><strong>📌 데이터 한계</strong>: 현재 2024-01-02부터 시작하여 최대 500거래일(2년) 기간의
  Z-Score 계산이 가능합니다. 과거 데이터가 추가될수록 장기 Z-Score의 신뢰도가 높아집니다.</p>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     3. 핵심 지표 정의
══════════════════════════════════════════════════════════ -->
<section id="s3">
<h2 class="sec"><span class="num">3</span> 핵심 지표 정의 및 수식</h2>

<!-- 3-1 Sff -->
<h3 id="s3-1">3-1. Sff (Supply Flow Force) — 유통물량 대비 순매수 강도</h3>

<p>
  Sff는 순매수 금액을 <strong>유통시총(종가 × 유통주식수)</strong>으로 나눈 비율입니다.
  유통시총이 작은 종목은 같은 금액도 훨씬 강한 수급 신호로 해석하는 것이 합리적이기 때문입니다.
</p>

<div class="formula">
<span class="comment"># 외국인 Sff</span>
<span class="key">foreign_sff</span>  <span class="op">=</span> 외국인_순매수금액 / (종가 × 유통주식수) × 100

<span class="comment"># 기관 Sff</span>
<span class="key">institution_sff</span> <span class="op">=</span> 기관_순매수금액   / (종가 × 유통주식수) × 100
</div>

<blockquote>
  예: 삼성전자 유통시총 100조, 외국인 +1,000억 순매수
  → <strong>sff = 0.001 × 100 = 0.1</strong>
  (유통시총의 0.1%를 외국인이 순매수)
</blockquote>

<p>
  이 비율은 종목 크기와 무관하므로 <strong>삼성전자 sff 0.1과 소형주 sff 0.1은 동일한 강도</strong>를
  의미합니다.
</p>

<!-- 3-2 Combined Sff -->
<h3 id="s3-2">3-2. Combined Sff — 외국인 중심 조건부 합산</h3>

<p>
  외국인과 기관 수급을 단순 합산하면 한 주체가 강하게 매수해도 다른 주체의 역매매로
  신호가 희석되거나 역전될 수 있습니다.
  이를 방지하기 위해 <strong>방향 일치 여부에 따라 합산 방식을 달리합니다.</strong>
</p>

<div class="formula">
<span class="comment"># 외국인·기관 방향 일치 여부 판단</span>
<span class="key">same_direction</span> <span class="op">=</span> (foreign_sff × institution_sff) > 0

<span class="comment"># 조건부 합산</span>
<span class="key">combined_sff</span> <span class="op">=</span> <span class="val">if</span> same_direction:
    foreign_sff + institution_sff × 기관가중치   <span class="comment"># 동반매수: 기관 부분 반영 (기본 30%)</span>
<span class="val">else</span>:
    foreign_sff                                  <span class="comment"># 역방향: 외국인만 반영</span>
</div>

<table>
  <tr><th>기관가중치</th><th>의미</th><th>상황</th></tr>
  <tr><td>0.0</td><td>외국인 신호만</td><td>기관 신뢰도가 낮을 때</td></tr>
  <tr><td>0.3 (기본)</td><td>외국인 중심, 기관 보조</td><td>일반적 분석 상황</td></tr>
  <tr><td>1.0</td><td>외국인 + 기관 동등 반영</td><td>기관 신호도 중요시할 때</td></tr>
</table>

<div class="box amber">
  <p><strong>역방향 무시 이유</strong>: 외국인이 강하게 매수할 때 기관이 역매매(차익실현 등)를 하는 경우,
  단순 합산하면 외국인의 매수 신호가 약화·역전됩니다. 이는 "외국인 매수"라는 핵심 신호를 희석하므로,
  역방향일 때는 외국인 신호만 사용합니다.</p>
</div>

<!-- 3-3 Z-Score -->
<h3 id="s3-3">3-3. Z-Score — 조건부 공식 (역사 대비 이례성 측정)</h3>

<p>
  Z-Score는 <strong>"오늘의 수급이 최근 N일 역사 대비 얼마나 이례적인가"</strong>를 나타냅니다.
  본 시스템에서는 표준 Z-Score 공식을 그대로 쓰면 발생하는 과잉 반응 문제를
  <strong>조건부 공식</strong>으로 해결합니다.
</p>

<h4>문제: 방향 전환 시 표준 공식의 과잉 반응</h4>
<div class="compare">
  <div class="compare-card before">
    <div class="cl">❌ 표준 공식 (오류 발생)</div>
    <p style="font-size:13px; color:#7f1d1d;">
      매수 평균 +0.488인 종목에서 오늘 살짝 매도(-0.038) 발생 시:<br>
      <strong>Z = (-0.038 - 0.488) / 0.436 = -1.21</strong><br>
      → 강한 매도 시그널로 오인 (실제는 노이즈 수준)
    </p>
  </div>
  <div class="compare-card after">
    <div class="cl">✅ 조건부 공식 (해결)</div>
    <p style="font-size:13px; color:#14532d;">
      방향이 바뀌었으므로 평균을 빼지 않고 크기만 평가:<br>
      <strong>Z = -0.038 / 0.436 = -0.087</strong><br>
      → 노이즈 수준으로 올바르게 처리
    </p>
  </div>
</div>

<div class="formula">
<span class="comment"># rolling_mean, rolling_std: N일 이동평균 및 이동표준편차</span>
<span class="key">same_sign</span> <span class="op">=</span> (오늘_sff × rolling_mean) > 0

<span class="key">Z-Score</span> <span class="op">=</span> <span class="val">if</span> same_sign:
    (오늘_sff - rolling_mean) / rolling_std   <span class="comment"># 같은 방향: 평균 대비 폭발 감지</span>
<span class="val">else</span>:
    오늘_sff / rolling_std                    <span class="comment"># 방향 전환: 크기만 평가</span>
</div>

<h4>7개 기간 — 투자 시계열별 해석</h4>
<table>
  <tr><th>기간</th><th>영업일</th><th>의미</th><th>포착하는 패턴</th></tr>
  <tr><td><span class="badge blue">5D</span></td><td>5일 ≈ 1주</td><td>오늘 수급이 최근 1주 대비</td><td>단기 급변, 당일 이슈</td></tr>
  <tr><td><span class="badge blue">10D</span></td><td>10일 ≈ 2주</td><td>최근 2주 기준</td><td>단기 추세 확인</td></tr>
  <tr><td><span class="badge blue">20D</span></td><td>20일 ≈ 1개월</td><td>최근 1개월 기준</td><td>월간 수급 트렌드</td></tr>
  <tr><td><span class="badge purple">50D</span></td><td>50일 ≈ 2.5개월</td><td>최근 분기 기준</td><td>중기 매집 여부</td></tr>
  <tr><td><span class="badge purple">100D</span></td><td>100일 ≈ 5개월</td><td>최근 반기 기준</td><td>중장기 흐름</td></tr>
  <tr><td><span class="badge gray">200D</span></td><td>200일 ≈ 10개월</td><td>최근 1년 기준</td><td>연간 수급 기조</td></tr>
  <tr><td><span class="badge gray">500D</span></td><td>500일 ≈ 2.5년</td><td>최근 2.5년 기준</td><td>초장기 구조적 변화</td></tr>
</table>

<div class="box sky">
  <p><strong>💡 Z-Score와 누적순매수의 차이</strong>: Z-Score는 <em>오늘 하루의 수급 강도가 역사적으로 얼마나 이례적인가</em>를 봅니다.
  누적순매수(전체 매수금액 합산)와는 다른 지표입니다. 장기 매도 중인 종목이어도 오늘 수급이 이례적으로 강하면 Z > 0이 될 수 있습니다.</p>
</div>

<!-- 3-4 방향 확신도 -->
<h3 id="s3-4">3-4. 방향 확신도 (Direction Confidence) — tanh 기반 가중치</h3>

<p>
  Z-Score는 "편차의 크기"를 측정하는 지표입니다. 그런데 장기간 매도세가 지속된 종목이 최근
  매도세가 <em>다소 완화</em>되면 Z-Score가 양수가 됩니다. 이 종목이 매수 순위 상단에 노출되는
  것은 의도치 않은 결과입니다.
</p>

<div class="box red">
  <p><strong>문제 사례</strong>: 현대모비스(012330) — 장기 매도세 지속 중, 최근 매도세 소폭 완화<br>
  → 표준 정렬: 모멘텀 상위 <strong>#1 (양수 Z-Score)</strong><br>
  → 실제로는 매도 중인 종목</p>
</div>

<div class="formula">
<span class="comment"># 오늘 수급의 방향과 강도를 [−1, 1] 범위로 압축</span>
<span class="key">confidence</span> <span class="op">=</span> tanh(오늘_sff / rolling_std)

<span class="comment"># Long 전략 정렬/분류 시</span>
<span class="key">adjusted_z</span> <span class="op">=</span> Z × max(confidence, 0)    <span class="comment"># 매수 방향 확신도만 반영</span>

<span class="comment"># Short 전략 정렬/분류 시</span>
<span class="key">adjusted_z</span> <span class="op">=</span> Z × max(-confidence, 0)   <span class="comment"># 매도 방향 확신도만 반영</span>
</div>

<table>
  <tr><th>tanh 값</th><th>의미</th></tr>
  <tr><td><strong>tanh = 0</strong></td><td>오늘 수급 = 0 (완전 중립, 노이즈 감쇠)</td></tr>
  <tr><td><strong>tanh ≈ 0.76</strong></td><td>sff/std = 1.0 (중간 수준 매수 신호)</td></tr>
  <tr><td><strong>tanh ≈ 0.96</strong></td><td>sff/std = 2.0 (강한 매수 신호 보존)</td></tr>
</table>

<div class="box green">
  <p><strong>결과</strong>: 현대모비스 — 조정 후 momentum <strong>+2.03 → 0.00</strong>, 패턴 모멘텀형 → 기타, 순위 #1 → #221<br>
  매도 중인 76개 종목(22.5%)의 오분류 모두 해결. tanh는 하드코딩 기준 없이 <em>각 종목 자신의 변동성(std)으로 자기 정규화</em>합니다.</p>
</div>

<div class="box gray">
  <p><strong>⚠️ 주의</strong>: 방향 확신도는 <em>정렬과 패턴 분류</em>에만 적용됩니다.
  히트맵에 표시되는 Z-Score 수치 자체는 원본 그대로 유지됩니다.
  tanh는 Z-Score 공식의 일부가 아니라 정렬 시 사용하는 별도 가중치 레이어입니다.</p>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     4. 분석 파이프라인
══════════════════════════════════════════════════════════ -->
<section id="s4">
<h2 class="sec"><span class="num">4</span> 분석 파이프라인 전체 구조</h2>

<div class="pipeline">
  <div class="pipe-item active">
    <div class="stage">STAGE 1</div>
    <div class="title">데이터 정규화</div>
    <div class="desc">Sff · Z-Score 계산</div>
  </div>
  <div class="pipe-item active">
    <div class="stage">STAGE 2</div>
    <div class="title">시공간 히트맵</div>
    <div class="desc">345종목 × 7기간</div>
  </div>
  <div class="pipe-item active">
    <div class="stage">STAGE 3</div>
    <div class="title">패턴 분류</div>
    <div class="desc">모멘텀·지속·전환</div>
  </div>
  <div class="pipe-item active">
    <div class="stage">STAGE 4</div>
    <div class="title">백테스트</div>
    <div class="desc">전략 검증 · 최적화</div>
  </div>
  <div class="pipe-item active">
    <div class="stage">STAGE 5</div>
    <div class="title">웹 대시보드</div>
    <div class="desc">Streamlit 실시간</div>
  </div>
</div>

<h3>Stage 1 — 데이터 정규화</h3>
<p>원시 수급 데이터(외국인·기관 순매수금액)를 Sff → Combined Sff → Z-Score 순으로 변환합니다.
이 단계에서 종목 간 크기 차이와 기간별 변동성이 제거되어 모든 종목을 동일한 기준으로 비교할 수 있게 됩니다.</p>

<h3>Stage 2 — 시공간 히트맵</h3>
<p>345개 종목 × 7개 기간의 Z-Score를 히트맵으로 시각화합니다. 행 = 종목, 열 = 기간이며,
색상이 붉을수록 강한 매수, 푸를수록 강한 매도입니다.
7가지 정렬 기준으로 관심 있는 종목군을 즉시 발굴할 수 있습니다.</p>

<h3>Stage 3 — 패턴 분류 및 시그널 통합</h3>
<p>7개 기간 Z-Score의 패턴을 분석하여 3가지 투자 유형으로 자동 분류합니다.
MA 골든크로스, 수급 가속도, 외인-기관 동조율 등의 추가 시그널을 탐지하여 최종 점수에 반영합니다.</p>

<h3>Stage 4 — 백테스트 (선택)</h3>
<p>과거 특정 기간에 이 시스템이 제시한 종목을 실제로 매매했다면 어떤 결과였을지를 시뮬레이션합니다.
거래세(0.20%), 수수료(0.015%), 슬리피지(0.1%)를 모두 반영한 현실적 수익률을 산출합니다.</p>

<h3>Stage 5 — 웹 대시보드</h3>
<p>위 모든 기능을 Streamlit 기반 웹 인터페이스로 제공합니다.
파라미터 조정, 결과 확인, 다운로드가 브라우저에서 실시간으로 가능합니다.</p>
</section>


<!-- ══════════════════════════════════════════════════════════
     5. 패턴 분류 시스템
══════════════════════════════════════════════════════════ -->
<section id="s5">
<h2 class="sec"><span class="num">5</span> 패턴 분류 시스템</h2>

<h3 id="s5-1">5-1. 3가지 패턴 유형</h3>

<div class="pattern-grid">
  <div class="pattern-card momentum">
    <h3>🚀 모멘텀형</h3>
    <p><strong>의미</strong>: 단기 수급이 폭발적으로 증가하는 종목</p>
    <ul>
      <li>단기(5D~10D) Z-Score 급등</li>
      <li>최근 수급이 장기 평균 대비 큰 폭 상회</li>
      <li>분기 이상 지속된 매수세가 최근 더 강해짐</li>
    </ul>
    <p style="margin-top:10px; font-size:12px; color:#1d4ed8;"><strong>투자 관점</strong>: 단기 모멘텀 추종 / 빠른 진입·청산</p>
  </div>
  <div class="pattern-card sustained">
    <h3>📦 지속형</h3>
    <p><strong>의미</strong>: 여러 기간에 걸쳐 꾸준히 매수가 축적되는 종목</p>
    <ul>
      <li>5D~200D 전 기간 Z-Score가 고르게 양수</li>
      <li>변동성 없이 지속적 매수 기조 유지</li>
      <li>장기 매집 패턴 (스마트머니 축적)</li>
    </ul>
    <p style="margin-top:10px; font-size:12px; color:#16a34a;"><strong>투자 관점</strong>: 중장기 보유 / 추세 추종</p>
  </div>
  <div class="pattern-card reversal">
    <h3>🔄 전환형</h3>
    <p><strong>의미</strong>: 매도세 이후 매수로 전환되는 초기 신호 종목</p>
    <ul>
      <li>장기 Z-Score는 부정적이나 단기 Z-Score 반등</li>
      <li>최근 수급 방향이 과거와 역전</li>
      <li>저가 반등 또는 추세 전환 초기 신호</li>
    </ul>
    <p style="margin-top:10px; font-size:12px; color:#7c3aed;"><strong>투자 관점</strong>: 역발상 투자 / 분할 매수</p>
  </div>
</div>

<div class="box gray">
  <p><strong>기타 패턴</strong>: 위 3가지 조건을 충족하지 않는 종목은 "기타"로 분류됩니다.
  분류 기준에는 방향 확신도(tanh)가 적용되므로, 수급 방향이 명확하지 않은 종목은 자동으로
  모멘텀형·지속형에서 탈락합니다.</p>
</div>

<h3 id="s5-2">5-2. 점수 체계 (0 ~ 115점)</h3>
<p>각 종목은 7개 기간 Z-Score를 조합한 <strong>패턴 점수(0~100점)</strong>에
추가 시그널 수를 반영한 <strong>최종 점수(최대 115점)</strong>를 받습니다.</p>

<div class="formula">
<span class="comment"># 패턴 점수 계산 (0~100)</span>
<span class="comment"># 각 구성 요소는 방향 확신도(tanh) 가중치 적용 후 계산</span>

<span class="key">가중합</span> <span class="op">=</span> recent × 0.25      <span class="comment"># 최근 강도 (5D Z-Score)</span>
       + momentum × 0.20    <span class="comment"># 장기 개선도 (최근 - 과거 변화율)</span>
       + weighted × 0.30    <span class="comment"># 중장기 가중 평균 (기간 가중합)</span>
       + average × 0.10     <span class="comment"># 전체 기간 단순 평균</span>
       + short_trend × 0.15 <span class="comment"># 단기 모멘텀 (5D - 20D)</span>

<span class="key">base_score</span> <span class="op">=</span> (가중합 + 3) / 6 × 100              <span class="comment"># Z[-3,3] → [0,100] 변환</span>
<span class="key">tc_bonus</span>   <span class="op">=</span> (temporal_consistency - 0.5) × 20   <span class="comment"># ±10점 보너스/페널티</span>
<span class="key">pattern_score</span> <span class="op">=</span> clip(base_score + tc_bonus, 0, 100)

<span class="comment"># 최종 점수</span>
<span class="key">final_score</span> <span class="op">=</span> pattern_score + signal_count × 5   <span class="comment"># 시그널 1개당 +5점, 최대 115점</span>
</div>

<h3 id="s5-3">5-3. 시간 일관성 (Temporal Consistency)</h3>
<p>
  꾸준한 매수 종목(5D > 10D > 20D > 50D > ... > 500D)과
  최근만 급등한 종목을 구분하는 지표입니다.
  인접한 두 기간 Z-Score의 순서가 "단기 ≥ 장기"를 만족하는 비율입니다.
</p>

<div class="formula">
<span class="comment"># 6쌍을 검사: (5D,10D) (10D,20D) (20D,50D) (50D,100D) (100D,200D) (200D,500D)</span>
<span class="key">temporal_consistency</span> <span class="op">=</span> 순서 일치 쌍 수 / 유효 쌍 수

<span class="comment"># 해석</span>
<span class="val">1.0</span>  <span class="comment"># 모든 쌍 순서 일치 → 꾸준한 상승 추세 (tc_bonus = +10점)</span>
<span class="val">0.5</span>  <span class="comment"># 절반만 일치 → 중립 (tc_bonus = 0점)</span>
<span class="val">0.0</span>  <span class="comment"># 모두 역순 → 불규칙 패턴 (tc_bonus = -10점)</span>
</div>

<h3 id="s5-4">5-4. 단기 모멘텀 (Short Trend)</h3>
<div class="formula">
<span class="key">short_trend</span> <span class="op">=</span> <span class="val">5D Z-Score</span> <span class="op">-</span> <span class="val">20D Z-Score</span>

<span class="comment"># 양수: 최근 1주가 최근 1개월보다 더 강한 매수 → 가속 중</span>
<span class="comment"># 음수: 최근 수급이 지난달보다 약해지는 중 → 감속</span>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     6. 추가 시그널
══════════════════════════════════════════════════════════ -->
<section id="s6">
<h2 class="sec"><span class="num">6</span> 추가 시그널 (패턴 점수 위에 가산)</h2>
<p>아래 3가지 시그널은 패턴 분류와는 독립적으로 탐지되며, 시그널이 발생할 때마다 최종 점수에 +5점씩 가산됩니다.</p>

<div class="signal-grid">
  <div class="signal-card">
    <h4>🔔 MA 골든크로스</h4>
    <p>외국인 수급의 이동평균 <strong>MA5 &gt; MA20</strong> 전환 시 발생.<br>
    단기 수급이 중기 평균을 상향 돌파하는 순간으로, 수급 트렌드 전환의 초기 신호입니다.</p>
  </div>
  <div class="signal-card">
    <h4>⚡ 수급 가속도</h4>
    <p>최근 N일간 수급 증가율이 임계값을 초과할 때 발생.<br>
    단순히 매수가 많은 것이 아니라, <strong>매수 강도가 증가하고 있는</strong> 종목을 포착합니다.</p>
  </div>
  <div class="signal-card">
    <h4>🤝 외인-기관 동조율</h4>
    <p>외국인과 기관이 <strong>같은 방향(매수)</strong>으로 동시에 움직이는 날의 비율.<br>
    두 큰 손이 함께 매수할 때 신뢰도가 높아집니다.</p>
  </div>
</div>

<div class="box blue">
  <p><strong>시그널 활용 인사이트</strong>: 백테스트 결과 시그널 2개 이상 종목은 승률 60%, 평균 +3~4%를 기록했습니다.
  반면 시그널 0~1개 종목은 승률 42%, 평균 -0.7%로 유의미한 차이를 보였습니다.
  <em>패턴 점수가 높더라도 시그널이 없으면 진입을 재고하는 것이 유리합니다.</em></p>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     7. 백테스트 시스템
══════════════════════════════════════════════════════════ -->
<section id="s7">
<h2 class="sec"><span class="num">7</span> 백테스트 시스템</h2>

<h3>기본 구조</h3>
<p>매 거래일마다 당일까지의 데이터만 사용하여 패턴을 스캔하고, 조건을 충족하는 종목에 진입·청산하는
롤링 윈도우 시뮬레이션입니다. 미래 데이터 누수(look-ahead bias)를 방지합니다.</p>

<h3>거래 비용 (완전 반영)</h3>
<table>
  <tr><th>항목</th><th>Long 전략</th><th>Short 전략</th></tr>
  <tr><td>증권거래세</td><td>0.20% (매도 시)</td><td>0.20% (청산 시)</td></tr>
  <tr><td>증권사 수수료</td><td>0.015% (왕복)</td><td>0.015% (왕복)</td></tr>
  <tr><td>슬리피지</td><td>0.10% (왕복)</td><td>0.10% (왕복)</td></tr>
  <tr><td>차입 비용</td><td>없음</td><td>연 3% (일할 계산)</td></tr>
  <tr><td><strong>왕복 총비용</strong></td><td><strong>0.43%</strong></td><td><strong>0.43% + 차입비용</strong></td></tr>
</table>

<h3>청산 조건 (우선순위 순)</h3>
<table>
  <tr><th>조건</th><th>기본값</th><th>설명</th></tr>
  <tr><td>목표 수익률 달성</td><td>+10%</td><td>Optuna 최적화 대상: 5~25%</td></tr>
  <tr><td>손절 발동</td><td>-5%</td><td>Optuna 최적화 대상: -15~-3%</td></tr>
  <tr><td>최대 보유 기간</td><td>15일</td><td>Optuna 최적화 대상: 1~500일</td></tr>
  <tr><td>반대 수급 신호</td><td>점수 75점 이상</td><td>매도 수급 패턴이 강해질 때</td></tr>
  <tr><td>백테스트 종료</td><td>마지막 거래일</td><td>미청산 포지션 강제 청산</td></tr>
</table>

<h3>Optuna 파라미터 최적화</h3>
<p>7개 파라미터를 Bayesian Optimization으로 자동 탐색합니다. Trial을 누적 실행할수록
최적값이 단조 증가(개선)되도록 SQLite에 Study를 영구 저장합니다.</p>

<table>
  <tr><th>파라미터</th><th>탐색 범위</th><th>의미</th></tr>
  <tr><td>min_score</td><td>50 ~ 90</td><td>진입 최소 점수</td></tr>
  <tr><td>min_signals</td><td>1 ~ 3</td><td>진입 최소 시그널 수</td></tr>
  <tr><td>target_return</td><td>5 ~ 25%</td><td>목표 수익률</td></tr>
  <tr><td>stop_loss</td><td>-15 ~ -3%</td><td>손절 비율</td></tr>
  <tr><td>max_positions</td><td>1 ~ 50</td><td>최대 동시 포지션 수</td></tr>
  <tr><td>max_hold_days</td><td>1 ~ 500일</td><td>최대 보유 기간</td></tr>
  <tr><td>reverse_signal_threshold</td><td>0 ~ 115</td><td>반대 수급 청산 점수 기준</td></tr>
</table>

<h3>실제 백테스트 검증 결과 (2024-06-01 ~ 2024-08-31)</h3>
<table>
  <tr><th>전략</th><th>총 수익률</th><th>승률</th><th>MDD</th><th>비고</th></tr>
  <tr><td>Long (순매수 종목)</td><td>-2.14%</td><td>46.5%</td><td>-13.62%</td><td>하락장 불리</td></tr>
  <tr><td><strong>Short (순매도 종목)</strong></td><td><strong>+0.56%</strong></td><td><strong>57.6%</strong></td><td>-12.25%</td><td>⭐ 하락장 유리</td></tr>
  <tr><td>Both (병행)</td><td>-3.75%</td><td>43.6%</td><td>-12.91%</td><td></td></tr>
</table>
<div class="box amber">
  <p><strong>해석</strong>: 2024년 여름(하락장 구간)에서는 숏 전략이 유효했습니다.
  같은 시스템으로 방향만 반대로 적용한 결과입니다. 시장 국면(상승/하락/횡보)에 따라
  전략 선택이 중요합니다.</p>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     8. 웹 대시보드 기능 안내
══════════════════════════════════════════════════════════ -->
<section id="s8">
<h2 class="sec"><span class="num">8</span> 웹 대시보드 기능 안내</h2>
<p>Streamlit 기반 멀티페이지 앱으로, 브라우저에서 <code>http://localhost:8501</code>로 접속합니다.</p>

<h3>🏠 홈 페이지 (Whale Supply)</h3>
<ul>
  <li><strong>KPI 카드 5개</strong>: 분석 종목 수, 강한 매수/매도 종목, 시그널 2개+ 종목</li>
  <li><strong>이상 수급 탭</strong>: Z-Score &gt; 2σ인 매수/매도 종목 차트 + 테이블 (날짜 조회 가능)</li>
  <li><strong>당일 수급 순위 탭</strong>: 외국인·기관 순매수/순매도 금액 Top 50</li>
  <li><strong>산출 방식 설명</strong>: Sff → Z-Score 계산 과정 expander</li>
</ul>

<h3>📊 히트맵 페이지</h3>
<ul>
  <li><strong>인터랙티브 히트맵</strong>: 345종목 × 7기간 Z-Score, 클릭 시 하단 미니 상세 패널</li>
  <li><strong>호버 정보</strong>: Z-Score 수치, 패턴, 점수, 시그널 수</li>
  <li><strong>정렬 7종</strong>: 패턴점수 / 최근 수급(5D) / 모멘텀 / 가중 평균 / 단순 평균 / 시그널 수</li>
  <li><strong>수급 방향 필터</strong>: 전체 / 매수 상위 / 매도 상위</li>
  <li><strong>필터 사이드바</strong>: 패턴 유형, 최소 점수, 최소 시그널 수</li>
  <li><strong>섹터 평균 히트맵 탭</strong>: 현재 필터 적용된 섹터별 평균 Z-Score</li>
</ul>

<h3>🔍 패턴분석 페이지</h3>
<ul>
  <li><strong>종목 리스트 탭</strong>: 정렬된 전체 종목 표 (패턴/점수/시그널 포함)</li>
  <li><strong>패턴별 통계 탭</strong>: 3개 패턴 분포 및 통계</li>
  <li><strong>시그널 분석 탭</strong>: 시그널 유형별 통계</li>
  <li><strong>섹터 크로스 분석 탭</strong>: 섹터 × 패턴 스택 바차트 + 교차 테이블</li>
  <li><strong>섹터 Z-Score 히트맵 탭</strong>: 섹터별 평균 Z-Score 히트맵</li>
  <li><strong>수급 집중도 탭</strong>: 섹터 집중도 점수 + 바차트</li>
  <li><strong>Treemap 탭</strong>: 섹터별 종목 박스 (크기=점수, 색=수급 강도)</li>
</ul>

<h3>📈 백테스트 페이지</h3>
<ul>
  <li><strong>KPI 카드</strong>: 총 수익률, 승률, MDD, 샤프 비율, 총 거래 수</li>
  <li><strong>차트 5종</strong>: 수익률 곡선, 낙폭 추이, 월별 수익률, 수익률 분포, 패턴별 성과</li>
  <li><strong>Optuna 최적화</strong>: 7개 파라미터 자동 탐색, 결과 즉시 반영</li>
  <li><strong>최적화/검증 기간 분리</strong>: 과적합 방지를 위한 out-of-sample 검증</li>
  <li><strong>거래 내역</strong>: 종목별 진입/청산/수익률 테이블 + CSV 다운로드</li>
</ul>

<h3>📋 종목 상세 페이지</h3>
<ul>
  <li><strong>KPI</strong>: 종합/외국인/기관 Z-Score, 현재가, 활성 시그널</li>
  <li><strong>Z-Score 추이 탭</strong>: 외국인/기관/종합 3선 + ±2σ 기준선 (N일 선택)</li>
  <li><strong>수급 금액 탭</strong>: 외국인/기관/개인 순매수 바차트 + 누적순매수 라인</li>
  <li><strong>시그널 &amp; MA 탭</strong>: 외국인 MA + 골든/데드크로스 + 가속도 메트릭</li>
  <li><strong>패턴 현황 탭</strong>: 7기간 Z-Score 바차트 + 진입/손절 가이드</li>
</ul>
</section>


<!-- ══════════════════════════════════════════════════════════
     9. 사용 방법
══════════════════════════════════════════════════════════ -->
<section id="s9">
<h2 class="sec"><span class="num">9</span> 사용 방법 (Step-by-Step)</h2>

<h3>실행 방법</h3>
<div class="formula">
<span class="comment"># 가상환경 활성화 후 Streamlit 실행</span>
venv/bin/streamlit run app/streamlit_app.py
<span class="comment"># → 브라우저에서 http://localhost:8501 접속</span>
</div>

<h3>기본 분석 흐름</h3>
<div class="steps">
  <div class="step">
    <div class="step-num">1</div>
    <div class="step-body">
      <h4>사이드바 파라미터 설정</h4>
      <p><strong>기관 가중치</strong> (기본 0.3): 기관 수급을 얼마나 반영할지 결정합니다.
      외국인 신호를 중심으로 보려면 낮게, 기관도 동등하게 보려면 1.0으로 설정합니다.</p>
      <p><strong>기준 날짜</strong>: 과거 특정 시점의 수급을 분석하고 싶으면 날짜를 변경합니다.
      기본값은 DB의 최신 날짜입니다.</p>
    </div>
  </div>
  <div class="step">
    <div class="step-num">2</div>
    <div class="step-body">
      <h4>히트맵 → 대상 종목군 좁히기</h4>
      <p>히트맵 페이지에서 정렬 방식을 선택합니다.</p>
      <ul style="font-size:13px; color:var(--text2); padding-left:18px;">
        <li><strong>패턴 점수 정렬</strong>: 종합적으로 가장 신호가 강한 종목</li>
        <li><strong>최근 수급(5D) 정렬</strong>: 최근 1주간 매수가 이례적으로 강한 종목</li>
        <li><strong>가중 평균 정렬</strong>: 단기~장기 전 기간에 걸쳐 고르게 강한 종목</li>
      </ul>
      <p>셀을 클릭하면 하단에 해당 종목의 미니 프로파일이 표시됩니다.</p>
    </div>
  </div>
  <div class="step">
    <div class="step-num">3</div>
    <div class="step-body">
      <h4>패턴분석 → 섹터/패턴 필터링</h4>
      <p>종목 리스트 탭에서 패턴 유형, 최소 점수, 시그널 수로 추가 필터링합니다.
      섹터 크로스 탭에서 현재 수급이 집중되는 섹터를 파악하고, Treemap으로 직관적 분포를 확인합니다.</p>
    </div>
  </div>
  <div class="step">
    <div class="step-num">4</div>
    <div class="step-body">
      <h4>종목 상세 → 개별 종목 심층 분석</h4>
      <p>히트맵 클릭 후 "종목 상세 보기" 버튼 또는 사이드바에서 직접 종목 선택.
      Z-Score 추이, 수급 금액 흐름, MA 골든크로스 발생 여부, 7기간 패턴 현황을 확인합니다.</p>
    </div>
  </div>
  <div class="step">
    <div class="step-num">5</div>
    <div class="step-body">
      <h4>(선택) 백테스트 → 전략 유효성 검증</h4>
      <p>관심 있는 파라미터 조합으로 백테스트를 실행합니다.
      "최적 파라미터 찾기" 버튼으로 Optuna가 자동으로 최적 조합을 탐색합니다.
      <strong>과적합 방지를 위해 최적화 기간과 검증 기간을 분리</strong>하는 것을 권장합니다.</p>
    </div>
  </div>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     10. 결과 해석 가이드
══════════════════════════════════════════════════════════ -->
<section id="s10">
<h2 class="sec"><span class="num">10</span> 결과 해석 가이드</h2>

<h3>Z-Score 해석</h3>

<div class="interp"><div class="interp-val" style="color:#dc2626">Z &gt; +3.0</div><div class="interp-desc">역사적으로 매우 이례적인 강한 매수. 단기 폭발 신호 가능성. 단, 단발성 이슈(공시 등) 확인 필요.</div></div>
<div class="interp"><div class="interp-val" style="color:#d97706">+2.0 ~ +3.0</div><div class="interp-desc">이상 수급 구간. 2σ 이상 → 통계적으로 유의미한 매수세. 패턴 확인 권장.</div></div>
<div class="interp"><div class="interp-val" style="color:#ca8a04">+1.0 ~ +2.0</div><div class="interp-desc">평균 이상의 매수. 추세 확인 중. 다른 기간 Z-Score와 함께 해석 필요.</div></div>
<div class="interp"><div class="interp-val" style="color:#64748b">-0.5 ~ +0.5</div><div class="interp-desc">중립 구간. 수급 방향이 불명확. 이 구간에서의 200D Z-Score는 장기 횡보 가능성을 시사.</div></div>
<div class="interp"><div class="interp-val" style="color:#0ea5e9">-1.0 ~ -2.0</div><div class="interp-desc">평균 이상의 매도. 매도 추세 형성 중.</div></div>
<div class="interp"><div class="interp-val" style="color:#2563eb">Z &lt; -2.0</div><div class="interp-desc">이상 매도 신호. Short 전략 대상 종목으로 검토 가능.</div></div>

<h3>다기간 패턴으로 시장 국면 판단</h3>
<table>
  <tr><th>패턴</th><th>5D</th><th>20D</th><th>100D</th><th>200D</th><th>해석</th></tr>
  <tr><td><span class="badge green">꾸준한 매집</span></td><td>+2.0</td><td>+1.8</td><td>+1.5</td><td>+1.0</td><td>스마트머니 장기 축적. 지속형 분류. 신뢰도 높음.</td></tr>
  <tr><td><span class="badge blue">최근 폭발</span></td><td>+3.0</td><td>+0.2</td><td>-0.5</td><td>-0.3</td><td>단기 급등. 모멘텀형. 지속성 불확실.</td></tr>
  <tr><td><span class="badge purple">전환 초기</span></td><td>+1.5</td><td>+0.5</td><td>-1.0</td><td>-1.5</td><td>장기 매도 후 단기 반전. 전환형. 분할 매수 고려.</td></tr>
  <tr><td><span class="badge amber">착시 주의</span></td><td>+1.0</td><td>-0.3</td><td>-2.0</td><td>-2.5</td><td>장기 매도 중 일시 완화. 방향 확신도(tanh)로 필터됨.</td></tr>
</table>

<h3>점수별 투자 참고 기준</h3>
<table>
  <tr><th>최종 점수</th><th>의미</th><th>권장 접근</th></tr>
  <tr><td><strong>85점 이상</strong></td><td>매우 강한 수급 신호 + 다수 시그널</td><td>적극 관심. 종목 상세 확인 후 판단.</td></tr>
  <tr><td><strong>70 ~ 85점</strong></td><td>유의미한 수급 패턴</td><td>관심 목록 등록. 시그널 수 2개 이상 시 우선 검토.</td></tr>
  <tr><td><strong>55 ~ 70점</strong></td><td>평균 이상, 트렌드 형성 중</td><td>추가 확인 후 선별. 시그널이 없으면 관망.</td></tr>
  <tr><td><strong>55점 미만</strong></td><td>뚜렷한 수급 신호 없음</td><td>수급 관점에서는 비추. 다른 분석 병행 필요.</td></tr>
</table>

<h3>섹터 분석 활용법</h3>
<p>개별 종목의 Z-Score가 높더라도 해당 섹터 전체가 강하면 섹터 순환(sector rotation)의 흐름을
타는 것일 수 있습니다. 반대로 섹터 평균은 낮은데 특정 종목만 높다면 그 종목에 선별적으로 자금이
유입되는 신호일 수 있습니다.</p>
<ul style="font-size:14px;">
  <li><strong>섹터 집중도 높음 + 개별 종목 높음</strong> → 섹터 테마 수혜, 여러 종목 분산 진입 고려</li>
  <li><strong>섹터 집중도 낮음 + 개별 종목 높음</strong> → 선별적 자금 유입, 해당 종목 집중 분석 필요</li>
</ul>

<h3>백테스트 지표 해석</h3>
<table>
  <tr><th>지표</th><th>의미</th><th>좋은 값의 기준</th></tr>
  <tr><td>총 수익률</td><td>전략의 누적 수익</td><td>벤치마크(코스피) 초과 여부</td></tr>
  <tr><td>승률</td><td>수익 거래 / 전체 거래</td><td>55% 이상 (단순 초과 수익 필요)</td></tr>
  <tr><td>Profit Factor</td><td>총 수익 / 총 손실</td><td>1.2 이상 (높을수록 좋음)</td></tr>
  <tr><td>MDD</td><td>최고점 대비 최대 낙폭</td><td>목표 수익률의 2배 이내</td></tr>
  <tr><td>샤프 비율</td><td>초과 수익 / 변동성</td><td>0.5 이상 (1.0 이상이면 우수)</td></tr>
  <tr><td>칼마 비율</td><td>수익률 / MDD</td><td>0.5 이상</td></tr>
</table>

<div class="box amber">
  <p><strong>⚠️ 백테스트 해석 주의사항</strong>: 백테스트는 과거 데이터 기반의 시뮬레이션이며 미래 수익을 보장하지 않습니다.
  특히 최적화된 파라미터는 해당 기간에 과적합될 수 있습니다.
  반드시 <strong>최적화 기간과 검증 기간을 분리</strong>(out-of-sample 검증)하여 결과의 신뢰도를 높이십시오.</p>
</div>
</section>


<!-- ══════════════════════════════════════════════════════════
     11. 성능 및 처리 속도
══════════════════════════════════════════════════════════ -->
<section id="s11">
<h2 class="sec"><span class="num">11</span> 성능 및 처리 속도</h2>

<table>
  <tr><th>기능</th><th>처리 내용</th><th>소요 시간</th><th>최적화 방법</th></tr>
  <tr><td>수급 분석 파이프라인</td><td>345종목 Stage 1~3 전체</td><td>~1.5초</td><td>groupby.transform 벡터화 + Sff 캐싱</td></tr>
  <tr><td>이상 수급 탐지</td><td>345종목 이상 신호 스캔</td><td>~15초</td><td>벡터화 완료</td></tr>
  <tr><td>백테스트 (38일)</td><td>2개월 롤링 윈도우</td><td>1.1초</td><td>Precomputer (기존 177초 → 165배 향상)</td></tr>
  <tr><td>백테스트 (1년)</td><td>250 거래일 시뮬레이션</td><td>~4초</td><td>Precomputer 자동 적용</td></tr>
  <tr><td>히트맵 렌더링</td><td>345×7 인터랙티브 차트</td><td>&lt;1초</td><td>Plotly 벡터 렌더링</td></tr>
</table>

<h3>BacktestPrecomputer — 핵심 속도 최적화</h3>
<p>
  백테스트의 병목은 "매 거래일마다 345종목의 Z-Score와 시그널을 재계산"하는 부분이었습니다.
  <strong>Precomputer</strong>는 백테스트 시작 전에 전 기간·전 종목의 계산을 한 번에 끝내고,
  실제 시뮬레이션에서는 O(1) 테이블 조회만 합니다.
</p>

<div class="formula">
<span class="comment"># Before: 매 거래일 × 345종목 = 매일 재계산</span>
<span class="comment"># After: 전체 기간 1회 벡터화 계산 → 조회만</span>

<span class="key">처리 시간</span>:
  38일 백테스트: <span class="val">177초</span> → <span class="val">1.1초</span>  (165배 향상)
  63일 백테스트: <span class="val">393초</span> → <span class="val">1.5초</span>  (262배 향상)
</div>
</section>

<hr>

<!-- 부록 -->
<div class="appendix">
  <h3 style="margin-bottom:16px;">📎 부록 — 용어 정리</h3>
  <table>
    <tr><th>용어</th><th>정의</th></tr>
    <tr><td>Sff (Supply Flow Force)</td><td>유통시총 대비 순매수 강도 (%). 종목 간 수급 비교를 위한 정규화 지표</td></tr>
    <tr><td>Combined Sff</td><td>외국인 중심 조건부 합산 Sff. 방향 일치 시 기관 부분 반영</td></tr>
    <tr><td>Z-Score</td><td>오늘 Sff가 N일 이동평균/표준편차 기준으로 몇 표준편차 이탈했는지</td></tr>
    <tr><td>조건부 Z-Score</td><td>방향 전환 시 과잉 반응 방지를 위한 수정 공식</td></tr>
    <tr><td>Direction Confidence</td><td>tanh(sff/std). 정렬·분류 시 방향 일치 여부에 따른 가중치 [-1, 1]</td></tr>
    <tr><td>Temporal Consistency</td><td>인접 기간 Z-Score 순서 일관성 (5D≥10D≥...≥500D). 0~1</td></tr>
    <tr><td>Short Trend</td><td>5D Z-Score - 20D Z-Score. 단기 수급 가속도 방향</td></tr>
    <tr><td>모멘텀형</td><td>단기 수급이 폭발적으로 강해지는 패턴</td></tr>
    <tr><td>지속형</td><td>전 기간에 걸쳐 꾸준한 매수가 축적되는 패턴</td></tr>
    <tr><td>전환형</td><td>장기 매도세 이후 단기 매수 전환이 나타나는 패턴</td></tr>
    <tr><td>MDD (Max Drawdown)</td><td>포트폴리오 최고점 대비 최대 낙폭 (%)</td></tr>
    <tr><td>샤프 비율</td><td>(수익률 - 무위험 수익률) / 수익률 표준편차. 위험 조정 수익률</td></tr>
    <tr><td>Optuna</td><td>Bayesian Optimization 기반 하이퍼파라미터 최적화 라이브러리</td></tr>
    <tr><td>Precomputer</td><td>백테스트 전 전 기간·전 종목 Z-Score/시그널을 벡터화 사전 계산하는 모듈</td></tr>
    <tr><td>Walk-Forward</td><td>학습 기간으로 파라미터 최적화 → 검증 기간으로 out-of-sample 검증을 롤링하는 방법</td></tr>
  </table>
</div>

<p style="text-align:center; color:var(--text3); font-size:13px; margin-top:48px;">
  Whale Supply — 외국인·기관 수급 분석 시스템 &nbsp;·&nbsp; 내부 보고용 &nbsp;·&nbsp; 2026-02-25
</p>

</body>
</html>
