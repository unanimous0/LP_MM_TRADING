# 수급 레짐 스캐너 - 분석 가이드

> **문서 목적**: 분석 방법론, 지표 정의, 해석 기준, 활용 방법 설명
>
> **마지막 업데이트**: 2026-02-14
> **버전**: v2.0

---

## 목차

1. [개요](#1-개요)
2. [분석 방법론](#2-분석-방법론)
3. [지표 및 수식 정의](#3-지표-및-수식-정의)
4. [패턴 분류 체계](#4-패턴-분류-체계)
5. [시그널 탐지 체계](#5-시그널-탐지-체계)
6. [점수 해석 가이드](#6-점수-해석-가이드)
7. [리포트 활용 방법](#7-리포트-활용-방법)
8. [실전 투자 전략 프레임워크](#8-실전-투자-전략-프레임워크)
9. [HTML 리포트 - Treemap 시각화](#9-html-리포트---treemap-시각화)
10. [참고 문서](#10-참고-문서)

---

## 1. 개요

### 1-1. 무엇을 분석하는가

**수급 레짐 스캐너**는 외국인/기관 투자자의 **수급 패턴**을 분석하여:
- ✅ 중장기 수급 강세 종목 선별
- ✅ 수급 전환점 포착 (단기 모멘텀)
- ✅ 진입 타이밍 시그널 제공

### 1-2. 핵심 철학

> **"과거 수급 패턴은 미래 주가의 선행 지표가 될 수 있다"**

- 외국인/기관의 지속적 매집 → 중장기 상승 확률 높음
- 수급 급변(전환점) → 단기 급등/급락 가능성
- 시가총액/변동성 보정 → 공정한 비교 가능

### 1-3. 사용 대상

- **KOSPI200 + KOSDAQ150** (약 345개 종목)
- 일평균 거래대금 10억 이상 (유동성 확보)
- 외국인/기관 수급 데이터 2년 이상 보유

---

## 2. 분석 방법론

### 2-1. Stage 1: 데이터 정규화

#### 목적
- 시가총액 왜곡 제거 (삼성전자 vs 중소형주 공정 비교)
- 변동성 보정 (평소 대비 이상 수급 탐지)

#### 핵심 지표

**[1] Sff (Supply Float Factor)**
```
Sff = (순매수 금액 / 유통시총) × 100
```
- 유통물량 대비 순매수 비율로 정규화
- 시총 크기와 무관하게 수급 강도 비교 가능

**[2] Z-Score**
```
Z-Score = (현재 Sff - 60일 평균 Sff) / 60일 표준편차
```
- 평소 대비 얼마나 강한/약한 수급인지 측정
- 변동성이 큰 종목과 작은 종목 공정 비교

**해석 기준**:
- Z > +2.0: 상위 2.5% 수준 (통계적 이상 매수)
- -2.0 < Z < +2.0: 중립
- Z < -2.0: 하위 2.5% 수준 (통계적 이상 매도)

---

### 2-2. Stage 2: 시공간 분석

#### 목적
- 단기/중기/장기 수급 트렌드 구분
- 수급 전환점 포착
- 일관성 vs 변동성 판단

#### 7개 기간 Z-Score 계산

| 기간 | 거래일 수 | 의미 | 활용 |
|------|-----------|------|------|
| **5D** | 5일 | 초단기 수급 | 전환점 포착 |
| **10D** | 10일 | 단기 트렌드 | 주간 추세 |
| **20D** | 20일 | 월간 트렌드 | 현재 강도 측정 |
| **50D** | 50일 | 중기 트렌드 | 분기 수급 흐름 |
| **100D** | 100일 | 중장기 트렌드 | 반기 일관성 |
| **200D** | 200일 | 장기 트렌드 | 연간 추세 |
| **500D** | 500일 | 초장기 기준선 | 역사적 비교 |

#### 4가지 정렬 키 계산

**[1] Recent (현재 강도)**
```python
Recent = (5D + 20D) / 2
```
- 의미: 지금 이 순간의 수급 강도
- 활용: 즉시 진입 타이밍 판단

**[2] Long Divergence (장기 이격도)**
```python
Long Divergence = 5D - 200D
```
- 의미: 단기(5일) vs 장기(200일) 수급 격차 (전환점)
- 활용: 급등 전 포착

**[3] Weighted (중장기 가중 트렌드)**
```python
Weighted = (5D×3.5 + 10D×3.0 + 20D×2.5 + 50D×2.0 + 100D×1.5 + 200D×1.0 + 500D×0.5) / 14.0
```
- 의미: 최근에 높은 가중치를 준 중장기 트렌드
- 활용: 지속적 매집 종목 선별

**[4] Average (전체 일관성)**
```python
Average = (5D + 10D + 20D + 50D + 100D + 200D + 500D) / 7
```
- 의미: 전 기간 동안의 수급 일관성
- 활용: 안정적 상승 종목 선별

---

### 2-3. Stage 3: 패턴 분류 + 시그널 통합

#### 목적
- 수급 패턴 기반 종목 자동 분류
- 진입 타이밍 시그널 탐지
- 투자 전략 자동 제시

#### 처리 흐름
```
1. 패턴 분류 (3개 바구니) → 종목 선별 (What)
2. 시그널 탐지 (3가지) → 타이밍 포착 (When)
3. 통합 리포트 생성 → 우선순위 정렬
```

---

## 3. 지표 및 수식 정의

### 3-1. Sff (Supply Float Factor)

**정의**:
```
Sff = (외국인 순매수 금액 / 유통시총) × 100
또는
Sff = ((외국인 + 기관) 순매수 금액 / 유통시총) × 100
```

**단위**: %
**예시**:
- 유통시총 1조원 종목에 100억 순매수 → Sff = 1.0%
- 유통시총 10조원 종목에 100억 순매수 → Sff = 0.1%

**의의**: 시총 크기와 무관하게 수급 강도 비교 가능

---

### 3-2. Z-Score

**정의**:
```
Z-Score = (현재 Sff - 60일 평균 Sff) / 60일 표준편차
```

**해석**:
- Z = 0: 평소 수준
- Z = +1: 평균보다 1 표준편차 높음 (상위 16%)
- Z = +2: 평균보다 2 표준편차 높음 (상위 2.5%, 이상 매수)
- Z = +3: 평균보다 3 표준편차 높음 (상위 0.1%, 극단 매수)

**의의**: 변동성이 다른 종목들을 공정하게 비교 가능

---

### 3-3. 정렬 키 상세

#### Recent (현재 강도)
```python
Recent = (5D + 20D) / 2
```
- 5일 + 20일 평균
- 현재 진행형 수급 강도 측정

#### Long Divergence (장기 이격도)
```python
Long Divergence = 5D - 200D
```
- 단기(5일) - 장기(200일) 격차
- 양수: 과거보다 개선 (전환점)
- 음수: 과거보다 약화 (조정 중)

#### Weighted (가중 트렌드)
```python
Weighted = (5D×3.5 + 10D×3.0 + 20D×2.5 + 50D×2.0 + 100D×1.5 + 200D×1.0 + 500D×0.5) / 14.0
```
- 최근 기간에 높은 가중치
- 중장기 매집 패턴 포착

#### Average (일관성)
```python
Average = (5D + 10D + 20D + 50D + 100D + 200D + 500D) / 7
```
- 전 기간 단순 평균
- 일관된 수급 흐름 측정

#### Persistence (양수 비율)
```python
Persistence = (양수 Z-Score 기간 개수) / 6
```
- 6개 기간 중 양수인 기간 비율
- 0.7 = 70% 이상 양수 (일관된 매수)

---

## 4. 패턴 분류 체계

### 4-1. 3가지 패턴

#### [1] 급등형 (Surge Pattern)

**정의**:
```python
조건: Long Divergence > 1.0 AND Recent > 0.5
```

**의미**:
- 과거 약세 → 최근 강세 전환
- 1주일 수급이 2년 대비 1.0 이상 개선
- 수급 전환점 포착

**투자 전략**:
- 스타일: 단기 트레이딩, 추격 매수
- 진입: 시그널 발생 시 즉시
- 손절: -5% (빠른 손절)
- 보유: 5~10일

**리스크**: ⚠️ 높음 (단기 전환 실패 시 급락)

---

#### [2] 지속형 (Sustained Pattern)

**정의**:
```python
조건: Weighted > 0.8 AND Persistence > 0.7
```

**의미**:
- 중장기 일관된 상승 추세
- 가중평균 > 0.8 (강한 트렌드)
- 70% 이상 기간 양수 (일관성)

**투자 전략**:
- 스타일: 중장기 추세 추종, 포지션 트레이딩
- 진입: 5~10% 조정 시 분할 매수
- 손절: -10% (여유 있게)
- 보유: 1~3개월

**리스크**: ✅ 중간 (안정적 상승, 장기 보유 가능)

---

#### [3] 전환형 (Reversal Pattern)

**정의**:
```python
조건: Weighted > 0.5 AND Long Divergence < 0
```

**의미**:
- 장기 강세 + 최근 약화
- 고점에서 조정 진행 중
- 반등 대기 상태

**투자 전략**:
- 스타일: 저가 매수 기회 포착
- 진입: 반등 시그널 확인 후 (시그널 2개 이상)
- 손절: -7%
- 보유: 2~4주

**리스크**: ⚠️ 높음 (추세 전환 실패 가능성)

---

#### [4] 기타 (Others)

**정의**:
```python
조건: 위 조건 모두 미충족
```

**의미**: 명확한 패턴 없음

**투자 전략**: 관망 (투자 부적합)

---

### 4-2. 점수 계산 공식

```python
# 1. 가중 합 계산
Weighted_sum = (Recent × 0.25) + (Long Divergence × 0.20) + (Weighted × 0.20) + (Average × 0.10) + (Short Divergence × 0.10) + (Mid Divergence × 0.10)

# 2. 0~100점 범위로 스케일링
Score = ((Weighted_sum + 3) / 6) × 100

# 3. 클리핑
Final_score = Clip(Score, 0, 100)
```

**해석**:
- 100점: 최강 수급 (Weighted_sum = +3.0)
- 50점: 중립 (Weighted_sum = 0.0)
- 0점: 최약 수급 (Weighted_sum = -3.0)

---

## 5. 시그널 탐지 체계

### 5-1. 3가지 시그널

#### [1] MA 골든크로스 (Moving Average Golden Cross)

**정의**:
```python
MA_short(5일) = 최근 5일 외국인 순매수 이동평균
MA_long(20일) = 최근 20일 외국인 순매수 이동평균

조건:
  현재일: MA_short > MA_long
  직전일: MA_short ≤ MA_long
```

**의미**:
- 단기 수급이 중기 수급을 상향 돌파
- 매수세 강화 시그널

**활용**: 즉시 진입 타이밍

---

#### [2] 수급 가속도 (Acceleration)

**정의**:
```python
Recent_avg = 최근 5일 (외국인+기관) 순매수 평균
Prev_avg = 직전 5일 (외국인+기관) 순매수 평균
Acceleration = Recent_avg / Prev_avg

조건: Acceleration > 1.5
```

**의미**:
- 수급이 1.5배 이상 가속
- 매수세 급증

**활용**: 단기 급등 가능성

---

#### [3] 외인-기관 동조율 (Synchronization Rate)

**정의**:
```python
Sync_days = (외인 순매수 > 0 AND 기관 순매수 > 0) 인 일수
Sync_rate = (Sync_days / 20일) × 100%

조건: Sync_rate > 75%
```

**의미**:
- 외인과 기관이 75% 이상 동시 매수
- 확신도 높은 종목

**활용**: 중장기 보유 종목 선별

---

### 5-2. 시그널 vs 패턴 비교

| 항목 | 패턴 분류 | 시그널 탐지 |
|------|-----------|-------------|
| **입력 데이터** | Z-Score (정규화) | Raw 금액 (원본) |
| **시간 범위** | 최대 2년 (504일) | 최대 20일 |
| **출력 형태** | 3가지 패턴 + 점수 (0~100) | 3가지 시그널 (0/1) |
| **계산 방식** | 가중 합 (Weighted sum) | 이동평균, 비율, 카운트 |
| **목적** | 종목 선별 (What) | 타이밍 포착 (When) |
| **역할** | 좋은 종목 찾기 | 매수 시점 찾기 |

**독립성**: 상관계수 0.051 (거의 무관)
**상호 보완 관계**: 패턴으로 종목 선별 → 시그널로 진입 타이밍

---

## 6. 점수 해석 가이드

### 6-1. 점수 구간별 의미

| 점수 구간 | 의미 | 투자 적합성 | 예상 비율 |
|-----------|------|-------------|-----------|
| **80~100점** | 초강세 수급 | ⭐⭐⭐ 강력 추천 | 1~3% |
| **70~80점** | 강세 수급 | ⭐⭐ 추천 | 10~15% |
| **60~70점** | 중립~약한 강세 | ⭐ 관심 | 25~35% |
| **50~60점** | 중립 | 관망 | 25~35% |
| **0~50점** | 약세 수급 | 회피 | 25~35% |

**권장 투자 대상**: 70점 이상 (약 10~15%)

---

### 6-2. 패턴별 해석

| 패턴 | 평균 점수 범위 | 표준편차 | 특징 |
|------|----------------|----------|------|
| 지속형 | 60~75점 | ±5~8 | 가장 높고 안정적 |
| 급등형 | 60~70점 | ±3~5 | 변동폭 작음 |
| 전환형 | 50~60점 | ±3~5 | 중립 수준 |
| 기타 | 40~55점 | ±8~12 | 낮고 불안정 |

---

### 6-3. 시그널 개수별 해석

| 시그널 개수 | 의미 | 점수 영향 | 전략 |
|-------------|------|-----------|------|
| **3개** | 극강 진입 신호 | +15점 | 즉시 진입 고려 |
| **2개** | 강한 진입 신호 | +10점 | 적극 진입 |
| **1개** | 약한 진입 신호 | +5점 | 조정 대기 |
| **0개** | 진입 신호 없음 | 0점 | 큰 조정 대기 |

**주의**: 시그널은 종목 '질'이 아닌 '타이밍' 지표

---

### 6-4. 종합 점수 계산

```python
종합 점수 = 패턴 점수 + (시그널 개수 × 5점)
```

**예시**:
- 지속형 75점 + 시그널 2개 → 종합 85점 (⭐⭐⭐ 강력 추천)
- 급등형 65점 + 시그널 1개 → 종합 70점 (⭐⭐ 추천)
- 전환형 55점 + 시그널 0개 → 종합 55점 (관망)

---

## 7. 리포트 활용 방법

### 7-1. 생성 가능한 리포트 형식

```bash
bash scripts/analysis/run_all.sh
```

**생성 파일**:
1. **Excel** (`regime_report_final.xlsx`) - 8개 시트
2. **CSV** (`regime_report_final.csv`) - 전체 데이터
3. **HTML** (`regime_report_final.html`) - 인터랙티브 대시보드
4. **Markdown** (`regime_report_final.md`) - GitHub/Obsidian용

---

### 7-2. Excel 리포트 구조

#### 시트 0: 용어설명
- 패턴, 시그널, 메트릭 정의
- 섹터 분류 기준 (60개 섹터)

#### 시트 1: 최종결론
- 종합 추천 순위 TOP 20
- 종합점수 = 패턴점수 + (시그널×5)

#### 시트 2: 점수순위
- 패턴 점수만 기준 TOP 30
- 종목의 '질' 평가

#### 시트 3: 시그널순위
- 시그널 개수 기준 TOP 30
- 진입 '타이밍' 평가

#### 시트 4: 패턴별순위
- 급등형 TOP 10
- 지속형 TOP 10
- 전환형 TOP 10

#### 시트 5: 섹터별상위
- 각 섹터별 TOP 3 종목
- 섹터 분산 투자 참고

#### 시트 6: 섹터수급집중도
- 섹터별 평균 점수
- 섹터별 고득점 종목 수
- 섹터 점수 = 평균점수 × (1 + 고득점/전체)

#### 시트 7: 전체데이터
- 전체 345개 종목
- 모든 컬럼 포함

---

### 7-3. HTML 리포트 활용

**주요 구성**:
1. **요약 카드** - 전체/패턴별 종목 수
2. **차트** - 패턴별 분포, 섹터별 평균 점수
3. **종합 추천 순위 TOP 20** - 정렬 가능한 테이블
4. **섹터별 수급 집중도** - 정렬 가능한 테이블
5. **Treemap** - 섹터별 종목 시각화

**Treemap 활용**:
- 박스 크기 = 종합점수 (크기로 점수 비교)
- 색상 = 점수 (빨강→노랑→초록)
- 호버 = 상세 정보 (종목명, 코드, 패턴, 시그널)

---

### 7-4. 필터링 옵션

#### CLI 도구 사용
```bash
# 급등형만, 점수 70점 이상
python scripts/analysis/regime_scanner.py --pattern 급등형 --min-score 70

# 시그널 2개 이상, 상위 10개
python scripts/analysis/regime_scanner.py --min-signals 2 --top 10

# 특정 섹터만
python scripts/analysis/regime_scanner.py --sector "반도체 및 관련장비"

# 콘솔 요약 카드 출력
python scripts/analysis/regime_scanner.py --print-cards --top 5
```

---

## 8. 실전 투자 전략 프레임워크

### 8-1. 4단계 종목 선별 프로세스

#### 1단계: 기본 필터링
```
조건: 70점 이상 + 지속형
목표: 전체의 10~15% 선별
```

#### 2단계: 섹터 분산
```
우선 섹터: 평균 점수 60점 이상 섹터
회피 섹터: 평균 점수 50점 미만 섹터
권장: 최소 3개 섹터 이상 분산
```

#### 3단계: 진입 타이밍 판단

**시그널 2개 이상**:
- 전략: 즉시 진입 고려
- 손절: -7%

**시그널 1개**:
- 전략: 5~10% 조정 대기 후 진입
- 손절: -8%

**시그널 0개**:
- 전략: 10~15% 조정 대기 후 분할 매수
- 손절: -10%

#### 4단계: 포지션 관리
```
- 총 투자금의 10% 이하씩 분산 (10종목 권장)
- 종목당 최대 1회 분할 매수 (50% + 50%)
- 월 1회 수급 재분석 및 리밸런싱
```

---

### 8-2. 리스크 관리 원칙

#### 손절 규칙
| 패턴 | 손절 기준 | 근거 |
|------|-----------|------|
| 지속형 | -10% | 중장기 수급 강세, 여유 필요 |
| 급등형 | -5% | 단기 전환 실패 시 빠른 손절 |
| 전환형 | -7% | 리스크 높음, 중간 손절 |

#### 재평가 주기
- **월 1회**: 전체 종목 수급 재분석
- **즉시**: 패턴 변경 시 (지속형 → 기타)
- **분기 1회**: 방법론 재검증

---

### 8-3. 포트폴리오 구성 원칙

**목표**: 10종목, 균등 분산

| 카테고리 | 종목 수 | 투자 비중 |
|----------|---------|-----------|
| 즉시 진입 (시그널 2+) | 3개 | 30% |
| 관심 종목 (시그널 1) | 3개 | 30% |
| 장기 보유 (시그널 0, 고득점) | 4개 | 40% |

**섹터 분산**: 최소 3개 이상 (권장 5~7개)

---

## 9. HTML 리포트 - Treemap 시각화

### 9-1. 개요

HTML 리포트에 **D3.js Treemap** 시각화를 추가하여 섹터별 종목 분포와 점수를 한눈에 볼 수 있도록 개선했습니다.

**목표**:
- ✅ 섹터별 수급 집중도를 시각적으로 표현
- ✅ 종합점수에 비례하는 박스 크기
- ✅ 직관적인 색상 코딩 (빨강 → 노랑 → 초록)
- ✅ 인터랙티브 툴팁으로 상세 정보 제공

### 9-2. 구현 과정

#### 1단계: 초기 Grid 히트맵 구현 (2026-02-14)

**구현 내용**:
- D3.js v7을 사용한 기본 Grid 히트맵
- X축: 섹터 내 종목들 (순서대로 나열)
- Y축: 섹터명
- 색상: YlOrRd 스케일 (40~100점 범위)

**문제점**:
- 박스 크기가 모두 동일하여 점수 차이 표현 부족
- 섹터 구분이 명확하지 않음
- 사용자가 원하는 Treemap 형식이 아님

#### 2단계: Treemap으로 전환 (2026-02-14)

**데이터 구조 변경**:
```python
# 계층 구조로 변경
treemap_data = {
    'name': 'root',
    'children': [
        {
            'name': '반도체',
            'children': [
                {
                    'name': '삼성전자',
                    'value': 85.5,  # 박스 크기 결정
                    'stock_code': '005930',
                    'combined_score': 85.5,
                    ...
                },
                ...
            ]
        },
        ...
    ]
}
```

**D3 Treemap 레이아웃**:
```javascript
// 계층 구조 생성
const root = d3.hierarchy(treemapData)
    .sum(d => d.value)  // 박스 크기 = 종합점수
    .sort((a, b) => b.value - a.value);

// Treemap 레이아웃
const treemap = d3.treemap()
    .size([width, height])
    .padding(1)
    .paddingTop(24)  // 섹터 이름 공간
    .round(true);
```

**주요 특징**:
- ✅ 박스 크기가 종합점수에 비례
- ✅ 섹터별로 그룹화된 레이아웃
- ✅ 색상: 빨강(낮음) → 노랑(중간) → 초록(높음)

#### 3단계: 스타일 개선 (2026-02-14)

**개선사항 1: 텍스트 가독성**
```javascript
// 배경색 명도에 따라 글자색 자동 조정
function getTextColor(bgColor) {
    const color = d3.color(bgColor);
    const luminance = 0.299 * color.r + 0.587 * color.g + 0.114 * color.b;
    return luminance > 140 ? '#1F2937' : '#FFFFFF';
}
```

**결과**:
- 빨강 배경 (낮은 점수) → 흰색 글자
- 초록 배경 (높은 점수) → 검은색 글자
- 노랑 배경 (중간 점수) → 검은색 글자

**개선사항 2: 범례 위치**
- Before: 우측 상단 (섹터명과 겹침)
- After: 상단 중앙 (깔끔한 배치)

**개선사항 3: 전체 스타일링**
- 둥근 모서리 (border-radius: 3px)
- 섹터 레이블에 반투명 검정 배경 추가
- 테두리 최적화 (1.5px 흰색)
- 호버 효과 개선 (brightness + stroke 강조)
- 중앙 정렬 텍스트

### 9-3. 최종 결과

#### 시각적 표현
- **박스 크기**: 종합점수에 비례 (점수 높을수록 큰 박스)
- **색상 코딩**:
  - 빨강 (40~60점): 낮은 점수
  - 노랑 (60~80점): 중간 점수
  - 초록 (80~100점): 높은 점수
- **섹터 구분**: 각 섹터가 하나의 큰 영역으로 묶임

#### 인터랙티브 기능
- **호버 효과**: 마우스 올리면 밝아지고 테두리 강조
- **상세 툴팁**: 종목명, 코드, 섹터, 패턴, 점수, 시그널 정보
- **시각적 피드백**: 부드러운 전환 애니메이션 (150~300ms)

#### 생성 파일
```
output/regime_report_final.html  (55KB)
  ↳ Treemap 시각화 포함
  ↳ Chart.js 차트 (패턴별 분포, 섹터별 평균 점수)
  ↳ 종합 추천 순위 TOP 20 테이블
  ↳ 섹터별 수급 집중도 테이블
```

### 9-4. 기술 스택

#### 라이브러리
- **D3.js v7**: Treemap 레이아웃 및 시각화
- **Tailwind CSS (CDN)**: 반응형 레이아웃
- **Chart.js (CDN)**: 패턴별/섹터별 차트

#### 주요 D3 API
```javascript
d3.hierarchy()         // 계층 구조 생성
d3.treemap()          // Treemap 레이아웃
d3.scaleSequential()  // 연속형 색상 스케일
d3.interpolateRdYlGn  // 빨강-노랑-초록 그라데이션
```

#### 색상 팔레트
```javascript
// 종합점수 스케일 (빨강 → 노랑 → 초록)
const colorScale = d3.scaleSequential()
    .domain([40, 100])
    .interpolator(d3.interpolateRdYlGn);

// 패턴 색상
const patternColors = {
    '급등형': '#EF4444',  // 빨강
    '지속형': '#3B82F6',    // 파랑
    '전환형': '#F59E0B'     // 주황
};
```

### 9-5. 주요 코드 설명

#### 데이터 준비 (Python)
```python
# Treemap 데이터 준비 (계층 구조: 섹터 > 종목)
treemap_data = {'name': 'root', 'children': []}

for _, sector_row in sector_concentration.iterrows():
    sector = sector_row['sector']
    sector_stocks = df[df['sector'] == sector].nlargest(10, 'combined_score')

    sector_node = {'name': sector, 'children': []}

    for _, stock in sector_stocks.iterrows():
        sector_node['children'].append({
            'name': stock['stock_name'],
            'value': float(stock['combined_score']),  # 박스 크기
            'stock_code': stock['stock_code'],
            'pattern': stock['pattern'],
            'signal_count': int(stock['signal_count']),
            ...
        })

    treemap_data['children'].append(sector_node)
```

#### Treemap 레이아웃 (JavaScript)
```javascript
// 계층 구조 생성
const root = d3.hierarchy(treemapData)
    .sum(d => d.value)
    .sort((a, b) => b.value - a.value);

// Treemap 레이아웃 설정
const treemap = d3.treemap()
    .size([width, height - margin.top])
    .padding(1)
    .paddingTop(24)
    .round(true);

treemap(root);
```

#### 텍스트 색상 자동 조정
```javascript
// 배경색의 명도(luminance)를 계산하여 텍스트 색상 결정
function getTextColor(bgColor) {
    const color = d3.color(bgColor);
    const luminance = 0.299 * color.r + 0.587 * color.g + 0.114 * color.b;
    return luminance > 140 ? '#1F2937' : '#FFFFFF';
}
```

### 9-6. 실행 방법

#### 전체 리포트 생성
```bash
# 모든 형식 (Excel, CSV, HTML, Markdown) 생성
bash scripts/analysis/run_all.sh
```

#### HTML만 생성
```bash
# 1. CSV 생성
python scripts/analysis/regime_scanner.py --save-csv output/regime_report.csv

# 2. HTML 생성
python scripts/analysis/generate_html_report.py \
    --input output/regime_report.csv \
    --output output/regime_report_final.html
```

#### 브라우저에서 열기
```bash
# Mac
open output/regime_report_final.html
```

### 9-7. 성능 최적화

#### 데이터 최적화
- 각 섹터당 상위 10개 종목만 표시
- 총 100개 내외의 박스로 렌더링 부하 최소화

#### 렌더링 최적화
- D3 `.round(true)` 옵션으로 정수 좌표 사용
- 호버 효과 transition 지속시간 최적화 (150~300ms)
- 불필요한 DOM 조작 최소화

#### 반응형 디자인
- 고정 크기 (1200x800px) SVG
- 스크롤 가능한 컨테이너로 작은 화면 대응

---

## 10. 참고 문서

### 프로젝트 문서
- **CLAUDE.md**: 프로젝트 상태 및 진행 현황
- **IMPLEMENTATION_GUIDE.md**: Stage 1~3 상세 구현 가이드
- **DATABASE_README.md**: 데이터베이스 스키마 및 사용법
- **README.md**: 프로젝트 소개 및 설치 방법

### 외부 참고자료
- [D3.js 공식 문서](https://d3js.org/)
- [Observable HQ - Treemap Examples](https://observablehq.com/@d3/treemap)
- [WCAG 2.1 Color Contrast](https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html)

---

**문서 버전**: v2.0
**마지막 업데이트**: 2026-02-14
**작성자**: Claude Sonnet 4.5 + unanimous0
